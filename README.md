# èµ·çš„è¯¾ - iOS Application

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºæ¨¡æ¿åŒ¹é…ç®—æ³•çš„ä¸­å›½ä¼ ç»Ÿé‡‘é’±å¦è¯†åˆ«iOSåº”ç”¨ï¼Œä½¿ç”¨SwiftUIã€Vision Frameworkå’ŒSwiftDataæ„å»ºã€‚

## æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **UIæ¡†æ¶**: SwiftUI
- **å›¾åƒè¯†åˆ«**: Vision Framework (Feature Printæ¨¡æ¿åŒ¹é…)
- **ç›¸æœºåŠŸèƒ½**: AVFoundation
- **æ•°æ®å­˜å‚¨**: SwiftData
- **éƒ¨ç½²ç›®æ ‡**: iOS 16+
- **å¼€å‘ç¯å¢ƒ**: Xcode 14+

### é¡¹ç›®ç»“æ„

```
TianjiApp/
â”œâ”€â”€ App/                          # åº”ç”¨å…¥å£å’Œä¸»ç•Œé¢
â”‚   â”œâ”€â”€ TianjiApp.swift           # Appä¸»å…¥å£
â”‚   â””â”€â”€ ContentView.swift           # ä¸»ç•Œé¢
â”œâ”€â”€ Camera/                       # ç›¸æœºç›¸å…³ç»„ä»¶
â”‚   â”œâ”€â”€ CameraManager.swift         # ç›¸æœºç®¡ç†å™¨
â”‚   â”œâ”€â”€ CameraPreview.swift         # ç›¸æœºé¢„è§ˆç»„ä»¶
â”‚   â””â”€â”€ CameraOverlay.swift         # 6æ§½ä½è¦†ç›–å±‚
â”œâ”€â”€ Recognition/                  # å›¾åƒè¯†åˆ«æ¨¡å—
â”‚   â”œâ”€â”€ TemplateManager.swift       # æ¨¡æ¿ç®¡ç†
â”‚   â”œâ”€â”€ ROICropper.swift          # ROIè£å‰ª
â”‚   â”œâ”€â”€ FeatureMatchService.swift   # ç‰¹å¾åŒ¹é…æœåŠ¡
â”‚   â””â”€â”€ CoinValidator.swift        # é“œé’±éªŒè¯
â”œâ”€â”€ Data/                         # æ•°æ®å±‚
â”‚   â”œâ”€â”€ Models/                   # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ CoinProfile.swift       # é“œé’±é…ç½®
â”‚   â”‚   â”œâ”€â”€ DivinationSession.swift # èµ·è¯¾è®°å½•
â”‚   â”‚   â”œâ”€â”€ CoinResult.swift       # è¯†åˆ«ç»“æœ
â”‚   â”‚   â””â”€â”€ Hexagram.swift       # å¦è±¡æ•°æ®
â”‚   â””â”€â”€ SwiftData/               # SwiftDataé…ç½®
â”‚       â”œâ”€â”€ TianjiSchema.swift
â”‚       â””â”€â”€ PersistenceController.swift
â”œâ”€â”€ Views/                        # è§†å›¾ç»„ä»¶
â”‚   â”œâ”€â”€ SetupProfileView.swift     # æ¨¡æ¿è®¾ç½®
â”‚   â”œâ”€â”€ CameraView.swift          # ç›¸æœºç•Œé¢
â”‚   â”œâ”€â”€ HistoryView.swift          # å†å²è®°å½•
â”‚   â””â”€â”€ ResultView.swift          # ç»“æœæ˜¾ç¤º
â”œâ”€â”€ Utils/                        # å·¥å…·ç±»
â”‚   â”œâ”€â”€ ImageProcessor.swift      # å›¾åƒå¤„ç†
â”‚   â””â”€â”€ ConfidenceCalculator.swift # ç½®ä¿¡åº¦è®¡ç®—
â”œâ”€â”€ Resources/                    # èµ„æºæ–‡ä»¶
â”‚   â”œâ”€â”€ HexagramData.json       # 64å¦æ•°æ®
â”‚   â””â”€â”€ Assets.xcassets        # åº”ç”¨èµ„æº
â””â”€â”€ TianjiApp.xcodeproj/      # Xcodeé¡¹ç›®æ–‡ä»¶
```

## æ ¸å¿ƒåŠŸèƒ½

### 1. é“œé’±æ¨¡æ¿è®¾ç½®
- ç”¨æˆ·ä¸Šä¼ 3-5å¼ é“œé’±æ­£åé¢ç…§ç‰‡
- ä½¿ç”¨Vision Frameworkç”ŸæˆFeature Printç‰¹å¾
- æ¨¡æ¿æ•°æ®å­˜å‚¨åœ¨SwiftDataä¸­

### 2. å›¾åƒè¯†åˆ«æµç¨‹
1. ç”¨æˆ·åœ¨6ä¸ªå‚ç›´æ§½ä½ä¸­æ”¾ç½®é“œé’±
2. æ‹ç…§å¹¶æŒ‰æ§½ä½åæ ‡è£å‰ªROI
3. è½®å»“æ£€æµ‹éªŒè¯é“œé’±æœ‰æ•ˆæ€§
4. Feature Printæ¨¡æ¿åŒ¹é…è¯†åˆ«æ­£åé¢
5. ç½®ä¿¡åº¦è®¡ç®—å’Œç»“æœéªŒè¯
6. ç”Ÿæˆ6çˆ»æ•°ç»„å¹¶è½¬æ¢ä¸ºå¦è±¡

### 3. å¦è±¡è½¬æ¢å’Œæ˜¾ç¤º
- å°†6çˆ»æ•°ç»„æ˜ å°„åˆ°64å¦ä¹‹ä¸€
- æ˜¾ç¤ºå¦åã€å¦å›¾ã€çˆ»è¯
- å±•ç¤ºå åœå›¾è§£å’Œæ–‡å­—è§£é‡Š
- ä¿å­˜å†å²è®°å½•

## æ•°æ®æ¨¡å‹

### CoinProfile (é“œé’±é…ç½®)
```swift
- id: UUID
- name: String                    // é…ç½®åç§°
- frontTemplates: Data             // å­—é¢æ¨¡æ¿ç‰¹å¾
- backTemplates: Data              // å›¾æ¡ˆé¢æ¨¡æ¿ç‰¹å¾
- createdDate: Date
```

### DivinationSession (èµ·è¯¾è®°å½•)
```swift
- id: UUID
- date: Date                     // èµ·è¯¾æ—¶é—´
- source: String                  // æ¥æº(camera/photo)
- profileId: UUID                // ä½¿ç”¨çš„æ¨¡æ¿ID
- results: [CoinResult]?          // è¯†åˆ«ç»“æœ
- imagePaths: [String]?          // å›¾ç‰‡è·¯å¾„
- roiPaths: [String]?           // ROIè·¯å¾„
```

### CoinResult (è¯†åˆ«ç»“æœ)
```swift
- position: Int                   // çˆ»ä½(1-6)
- yinYang: YinYang               // é˜´é˜³å±æ€§
- side: CoinSide                 // æ­£åé¢
- confidence: Double             // ç½®ä¿¡åº¦(0.0-1.0)
```

## è¯†åˆ«ç®—æ³•

### æ¨¡æ¿åŒ¹é…æµç¨‹
1. **ç‰¹å¾æå–**: ä½¿ç”¨VNGenerateImageFeaturePrintRequestç”Ÿæˆè§†è§‰ç‰¹å¾
2. **ROIè£å‰ª**: æŒ‰6ä¸ªæ§½ä½åæ ‡è£å‰ªæ„Ÿå…´è¶£åŒºåŸŸ
3. **æœ‰æ•ˆæ€§éªŒè¯**: ä½¿ç”¨VNDetectContoursRequestæ£€æµ‹é“œé’±è½®å»“
4. **ç‰¹å¾åŒ¹é…**: è®¡ç®—ROIç‰¹å¾ä¸æ¨¡æ¿ç‰¹å¾çš„æ¬§æ°è·ç¦»
5. **ç½®ä¿¡åº¦è®¡ç®—**: åŸºäºè·ç¦»å·®å€¼è®¡ç®—è¯†åˆ«ç½®ä¿¡åº¦
6. **ç»“æœåˆ¤å®š**: ç½®ä¿¡åº¦>0.3ä¸”è·ç¦»å·®å€¼è¶³å¤Ÿå¤§æ‰æ¥å—ç»“æœ

### ç½®ä¿¡åº¦è®¡ç®—
```swift
confidence = 1.0 - (min_distance / total_distance)
side = front_distance < back_distance ? front : back
```

## ç”¨æˆ·ç•Œé¢

### ä¸»ç•Œé¢
- è®¾ç½®é“œé’±æ¨¡æ¿
- å¼€å§‹èµ·è¯¾
- å†å²è®°å½•

### ç›¸æœºç•Œé¢
- å®æ—¶ç›¸æœºé¢„è§ˆ
- 6ä¸ªå‚ç›´æ’åˆ—çš„æ§½ä½overlay
- æ‹ç…§å’Œè¯†åˆ«æŒ‰é’®
- å¤„ç†è¿›åº¦æ˜¾ç¤º

### ç»“æœç•Œé¢
- å¦è±¡ä¿¡æ¯æ˜¾ç¤º
- å…­çˆ»æ’åˆ—
- çˆ»è¯æ˜¾ç¤º
- å åœå›¾è§£å±•ç¤º
- å¦è±¡è§£é‡Šæ–‡æœ¬

### å†å²è®°å½•
- æŒ‰æ—¶é—´æ’åºçš„èµ·è¯¾è®°å½•
- è¯¦ç»†ä¿¡æ¯æŸ¥çœ‹
- è®°å½•åˆ é™¤åŠŸèƒ½

## æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡æ€§èƒ½
- **è¯†åˆ«é€Ÿåº¦**: <1ç§’/å¼ å›¾ç‰‡
- **å‡†ç¡®åº¦**: 85-95%
- **å†…å­˜å ç”¨**: <100MB
- **æ¨¡æ¿è®¾ç½®**: 2-3åˆ†é’Ÿå®Œæˆ

### ä¼˜åŒ–ç­–ç•¥
- å¼‚æ­¥å›¾åƒå¤„ç†
- å¹¶å‘ç‰¹å¾åŒ¹é…
- é«˜æ•ˆçš„æ•°æ®ç»“æ„
- å†…å­˜ç¼“å­˜ä¼˜åŒ–

## å¼€å‘çŠ¶æ€

### âœ… å·²å®Œæˆ
- [x] é¡¹ç›®æ¶æ„è®¾è®¡
- [x] 64å¦æ•°æ®å‡†å¤‡
- [x] iOSé¡¹ç›®åŸºç¡€ç»“æ„
- [x] ç›¸æœºé¢„è§ˆå’Œæ§½ä½UI
- [x] ROIè£å‰ªå’Œæ¨¡æ¿åŒ¹é…åŠŸèƒ½
- [x] æ•°æ®æŒä¹…åŒ–
- [x] å¦è±¡è½¬æ¢å’Œç»“æœæ˜¾ç¤º

### ğŸ“‹ å¾…å®Œå–„
- [ ] çœŸæœºæµ‹è¯•å’Œè°ƒè¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] ç”¨æˆ·å¼•å¯¼å’Œå¸®åŠ©
- [ ] å åœå›¾é«˜æ¸…ç‰ˆæœ¬é›†æˆ

## æ„å»ºå’Œè¿è¡Œ

### å‰ç½®æ¡ä»¶
- macOS 13+ with Xcode 14+
- iOS 16+ è®¾å¤‡ç”¨äºç›¸æœºåŠŸèƒ½æµ‹è¯•
- å¼€å‘è€…è´¦å·ç”¨äºçœŸæœºè°ƒè¯•

### æ„å»ºå‘½ä»¤
```bash
# æ¨¡æ‹Ÿå™¨æ„å»º
xcodebuild -project TianjiApp.xcodeproj -scheme TianjiApp -sdk iphonesimulator build

# çœŸæœºæ„å»º
xcodebuild -project TianjiApp.xcodeproj -scheme TianjiApp -sdk iphoneos build

# è¿è¡Œæµ‹è¯•
xcodebuild test -project TianjiApp.xcodeproj -scheme TianjiApp -destination 'platform=iOS Simulator,name=iPhone 15'
```

## æ³¨æ„äº‹é¡¹

### æƒé™é…ç½®
éœ€è¦åœ¨Info.plistä¸­é…ç½®ï¼š
- `NSCameraUsageDescription`: ç›¸æœºè®¿é—®æƒé™
- `NSPhotoLibraryUsageDescription`: ç›¸å†Œè®¿é—®æƒé™

### è®¾å¤‡è¦æ±‚
- æ¨èiPhone 12åŠä»¥ä¸Šè®¾å¤‡
- éœ€è¦åç½®æ‘„åƒå¤´
- iOS 16.0+

### å·²çŸ¥é™åˆ¶
- ç›®å‰ä»…æ”¯æŒå•ä¸ªé“œé’±é…ç½®
- å åœå›¾ä¸ºæ–‡å­—æè¿°ï¼Œéœ€è¦é›†æˆé«˜æ¸…å›¾ç‰‡
- çœŸæœºæµ‹è¯•æœªå®Œæˆï¼Œå¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜

## æœªæ¥æ‰©å±•

### çŸ­æœŸè®¡åˆ’
- [ ] å åœå›¾é«˜æ¸…å›¾ç‰‡é›†æˆ
- [ ] ç›¸å†Œå›¾ç‰‡é€‰æ‹©æ”¯æŒ
- [ ] å¤šé“œé’±é…ç½®æ”¯æŒ
- [ ] å†å²è®°å½•å¯¼å‡ºåŠŸèƒ½

### é•¿æœŸè§„åˆ’
- [ ] iCloudæ•°æ®åŒæ­¥
- [ ] Apple Watchæ”¯æŒ
- [ ] å åœç»“æœåˆ†äº«åŠŸèƒ½
- [ ] ç”¨æˆ·ç¤¾åŒºå’Œç»éªŒåˆ†äº«

## è®¸å¯è¯

æœ¬é¡¹ç›®ä¸ºä¸ªäººå­¦ä¹ å’Œç ”ç©¶ç”¨é€”ã€‚

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘è€…ã€‚